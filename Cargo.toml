[package]
name = "nameshed-hsm-relay"
version = "0.1.0"
edition = "2024"
authors = ["NLnet Labs <nameshed@nlnetlabs.nl>"]
description = "KMIP to PKCS#11 HSM relay for the Nameshed project."
repository = "https://github.com/NLnetLabs/nameshed-hsm-relay/"
keywords = ["KMIP", "PKCS#11", "HSM", "Rust"]
categories = ["cryptography"]
license = "BSD-3-Clause"
readme = "README.md"
exclude = [ ".github", ".gitignore" ]

[dependencies]
bcder = "0.7.5"
clap = { version = "4.5", features = ["cargo", "derive"] }
cryptoki = "^0.10.0"
domain = { git = "https://github.com/NLnetLabs/domain.git", branch = "patches-for-nameshed-prototype", features = [
    "unstable-crypto-sign",
] }
hex = "0.4"
kmip-ttlv = { git = "https://github.com/NLnetLabs/kmip-ttlv", branch = "next", version = "0.4.0", default-features = false, features = [
    "async-with-tokio",
    "high-level",
] }
kmip = { git = "https://github.com/NLnetLabs/kmip-protocol", branch = "next", package = "kmip-protocol", version = "0.5", default-features = false, features = [
    "tls-with-tokio-rustls",
] }
log = "0.4"
moka = { version = "0.12.10", features = ["sync"] }
r2d2 = "0.8.10"
rand = "0.9.1"
rcgen = { version = "0.14.2", optional = true }
rpki = { version = "0.18", features = ["crypto"] }
tokio = { version = "1.46.1", features = ["macros", "net", "rt-multi-thread"] }
rustls = "0.23.29"
tokio-rustls = "0.26.2"
daemonbase = "0.1.3"
serde = { version = "1.0.219", features = ["derive"] }
toml = "0.9.2"

[features]
default = ["domain/ring", "rcgen"]
openssl = ["domain/openssl"]

[profile.release]
panic = "abort"

[package.metadata.deb]
name = "nameshed-hsm-relay"
maintainer = "NLnet Labs <nameshed@nlnetlabs.nl>"
license-file = ["LICENSE", "0"]
extended-description = """\
KMIP to PKCS#11 HSM relay for the Nameshed project."""
depends = "$auto, passwd"
section = "net"
priority = "optional"
assets = [
    ["target/release/nameshed-hsm-relay", "usr/bin/", "755"],
    ["README.md", "usr/share/doc/nameshed-hsm-relay/", "644"],
    #["doc/nameshed-hsm-relay.1", "usr/share/man/man1/nameshed-hsm-relay.1", "644"],
    ["etc/nameshed-hsm-relay.conf.system-service", "etc/nameshed-hsm-relay.conf", "644"]
]
maintainer-scripts = "pkg/debian"
changelog = "target/debian/changelog" # this will be generated by the pkg workflow
copyright = "Copyright (c) 2025, NLnet Labs. All rights reserved."
conf-files = ["/etc/nameshed-hsm-relay.conf"]
systemd-units = { unit-name = "nameshed-hsm-relay", unit-scripts = "pkg/common", enable = false }

[package.metadata.generate-rpm]
assets = [
    { source = "target/release/nameshed-hsm-relay", dest = "/usr/bin/nameshed-hsm-relay", mode = "755" },
    { source = "target/rpm/nameshed-hsm-relay.service", dest = "/lib/systemd/system/nameshed-hsm-relay.service", mode = "644" },
    #{ source = "doc/nameshed-hsm-relay.1", dest = "/usr/share/man/man1/nameshed-hsm-relay.1", mode = "644", doc = true },
    { source = "etc/nameshed-hsm-relay.conf.system-service", dest = "/etc/nameshed-hsm-relay/nameshed-hsm-relay.conf", mode = "644", config = true }
]
# These get set using cargo-generate-rpm --set-metadata at package build time.
#post_install_script = ...
#pre_uninstall_script = ...
#post_uninstall_script = ...

# ensure that the useradd and rsync tools are present by installing their respective packages
[package.metadata.generate-rpm.requires]
shadow-utils = "*"
